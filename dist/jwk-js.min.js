!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("crypto")):"function"==typeof define&&define.amd?define(["exports","crypto"],e):e(t.jwkJs={},null)}(this,function(t,o){"use strict";o=o&&o.hasOwnProperty("default")?o.default:o;var u=1e13,f=function(){function t(t){this.buf=[+t||0]}return t.prototype.mulAdd=function(t,e){var r,n,i=this.buf,o=i.length;for(r=0;r<o;++r)(n=i[r]*t+e)<u?e=0:n-=(e=0|n/u)*u,i[r]=n;0<e&&(i[r]=e)},t.prototype.sub=function(t){var e,r,n=this.buf,i=n.length;for(e=0;e<i;++e)t=(r=n[e]-t)<0?(r+=u,1):0,n[e]=r;for(;0===n[n.length-1];)n.pop()},t.prototype.toString=function(t){if(10!=(t||10))throw"only base 10 is supported";for(var e=this.buf,r=e[e.length-1].toString(),n=e.length-2;0<=n;--n)r+=(u+e[n]).toString().substring(1);return r},t.prototype.valueOf=function(){for(var t=this.buf,e=0,r=t.length-1;0<=r;--r)e=e*u+t[r];return e},t.prototype.simplify=function(){var t=this.buf;return 1==t.length?t[0]:this},t}(),c="Illegal argument specified!";function e(t,e){return t+("0"+e.toString(16)).slice(-2)}function r(t){return 0===t[0]?r(t.slice(1)):t}function n(t){if(!t)throw new Error(c);var e=t.match(/[0-9A-F]{2}/gi);if(!e)throw new Error(c);return new Uint8Array(e.map(function(t){return parseInt(t,16)}))}function s(t){try{return Promise.resolve(t())}catch(t){return Promise.reject(t)}}function p(t){for(var e=new Uint8Array(t.length),r=0;r<t.length;r++)e[r]=t.charCodeAt(r);return e}function g(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),String.fromCharCode.apply(String,t)}function a(t){try{if("object"==typeof window&&"function"==typeof window.atob)return window.atob(t);if("undefined"!=typeof Buffer)return Buffer.from(t,"base64").toString("binary");throw new Error(c)}catch(t){throw new Error(t)}}function l(t){if("string"!=typeof t||t.length%4!=0)throw new Error(c);return t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function h(t){if("string"!=typeof t||t.length%4==1)throw new Error(c);for(;t.length%4!=0;)t+="=";return t.replace(/\-/g,"+").replace(/_/g,"/")}function d(t){return a(h(t))}function b(t){try{if("object"==typeof window&&"function"==typeof window.atob)return window.btoa(t);if("undefined"!=typeof Buffer)return Buffer.from(t).toString("base64");throw new Error(c)}catch(t){throw new Error(t)}}function v(t){return l(b(t))}var y="â€¦",m=/^(\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/,S=/^(\d\d\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/;function w(t,e){return t.length>e&&(t=t.substring(0,e)+y),t}var E=function(){function r(t,e){void 0===e&&(e=0),this.hexDigits="0123456789ABCDEF",t instanceof r?(this.enc=t.enc,this.pos=t.pos):(this.enc=t,this.pos=e)}return r.prototype.get=function(t){if(void 0===t&&(t=this.pos++),t>=this.enc.length)throw"Requesting byte offset "+t+" on a stream of length "+this.enc.length;return"string"==typeof this.enc?this.enc.charCodeAt(t):this.enc[t]},r.prototype.hexByte=function(t){return this.hexDigits.charAt(t>>4&15)+this.hexDigits.charAt(15&t)},r.prototype.hexDump=function(t,e,r){for(var n="",i=t;i<e;++i)if(n+=this.hexByte(this.get(i)),!0!==r)switch(15&i){case 7:n+="  ";break;case 15:n+="\n";break;default:n+=" "}return n},r.prototype.isASCII=function(t,e){for(var r=t;r<e;++r){var n=this.get(r);if(n<32||176<n)return!1}return!0},r.prototype.parseStringISO=function(t,e){for(var r="",n=t;n<e;++n)r+=String.fromCharCode(this.get(n));return r},r.prototype.parseStringUTF=function(t,e){for(var r="",n=t;n<e;){var i=this.get(n++);r+=i<128?String.fromCharCode(i):191<i&&i<224?String.fromCharCode((31&i)<<6|63&this.get(n++)):String.fromCharCode((15&i)<<12|(63&this.get(n++))<<6|63&this.get(n++))}return r},r.prototype.parseStringBMP=function(t,e){for(var r,n,i="",o=t;o<e;)r=this.get(o++),n=this.get(o++),i+=String.fromCharCode(r<<8|n);return i},r.prototype.parseTime=function(t,e,r){var n=this.parseStringISO(t,e),i=(r?m:S).exec(n);if(!i)return"Unrecognized time: "+n;if(r){var o=+i[1]<70?2e3:1900;i[1]=o+""}return n=i[1]+"-"+i[2]+"-"+i[3]+" "+i[4],i[5]&&(n+=":"+i[5],i[6]&&(n+=":"+i[6],i[7]&&(n+="."+i[7]))),i[8]&&(n+=" UTC","Z"!=i[8]&&(n+=i[8],i[9]&&(n+=":"+i[9]))),n},r.prototype.parseInteger=function(t,e){for(var r,n=this.get(t),i=127<n,o=i?255:0,u="";n==o&&++t<e;)n=this.get(t);if(0===(r=e-t))return i?-1:0;if(4<r){var s=+n;for(r<<=3;0==(128&(s^o));)s<<=1,--r;u="("+r+" bit)\n"}i&&(n-=256);for(var a=new f(n),c=t+1;c<e;++c)a.mulAdd(256,this.get(c));return u+a.toString()},r.prototype.parseBitString=function(t,e,r){for(var n=this.get(t),i="("+((e-t-1<<3)-n)+" bit)\n",o="",u=t+1;u<e;++u){for(var s=this.get(u),a=u==e-1?n:0,c=7;a<=c;--c)o+=s>>c&1?"1":"0";if(o.length>r)return i+w(o,r)}return i+o},r.prototype.parseOctetString=function(t,e,r){if(this.isASCII(t,e))return w(this.parseStringISO(t,e),r);var n=e-t,i="("+n+" byte)\n";(r/=2)<n&&(e=t+r);for(var o=t;o<e;++o)i+=this.hexByte(this.get(o));return r<n&&(i+=y),i},r.prototype.parseOID=function(t,e,r){for(var n="",i=new f,o=0,u=t;u<e;++u){var s=this.get(u);if(i.mulAdd(128,127&s),o+=7,!(128&s)){if(""===n)if((i=i.simplify())instanceof f)i.sub(80),n="2."+i.toString();else{var a=i<80?i<40?0:1:2;n=a+"."+(i-40*a)}else n+="."+i.toString();if(n.length>r)return w(n,r);i=new f,o=0}}return 0<o&&(n+=".incomplete"),n},r}(),A=function(){function c(t,e,r,n,i){if(!(n instanceof C))throw"Invalid tag value.";this.stream=t,this.header=e,this.length=r,this.tag=n,this.sub=i}return c.decodeLength=function(t){var e=t.get(),r=127&e;if(r==e)return r;if(6<r)throw"Length over 48 bits not supported at position "+(t.pos-1);if(0==r)return null;for(var n=e=0;n<r;++n)e=256*e+t.get();return e},c.decode=function(r){r instanceof E||(r=new E(r,0));var t=new E(r),e=new C(r),n=c.decodeLength(r),i=null,o=r.pos,u=o-t.pos,s=function(){if(i=[],null!==n){for(var t=o+n;r.pos<t;)i[i.length]=c.decode(r);if(r.pos!=t)throw"Content size is not correct for container starting at offset "+o}else try{for(;;){var e=c.decode(r);if(e.tag.isEOC())break;i[i.length]=e}n=o-r.pos}catch(t){throw"Exception while decoding undefined length content: "+t}};if(e.tagConstructed)s();else if(e.isUniversal()&&(3==e.tagNumber||4==e.tagNumber))try{if(3==e.tagNumber&&0!=r.get())throw"BIT STRINGs with unused bits cannot encapsulate.";s();for(var a=0;a<i.length;++a)if(i[a].tag.isEOC())throw"EOC is not supposed to be actual content."}catch(t){i=null}if(null===i){if(null===n)throw"We can't skip over an invalid tag with undefined length at offset "+o;r.pos=o+Math.abs(n)}return new c(t,u,n,e,i)},c.prototype.typeName=function(){switch(this.tag.tagClass){case 0:switch(this.tag.tagNumber){case 0:return"EOC";case 1:return"BOOLEAN";case 2:return"INTEGER";case 3:return"BIT_STRING";case 4:return"OCTET_STRING";case 5:return"NULL";case 6:return"OBJECT_IDENTIFIER";case 7:return"ObjectDescriptor";case 8:return"EXTERNAL";case 9:return"REAL";case 10:return"ENUMERATED";case 11:return"EMBEDDED_PDV";case 12:return"UTF8String";case 16:return"SEQUENCE";case 17:return"SET";case 18:return"NumericString";case 19:return"PrintableString";case 20:return"TeletexString";case 21:return"VideotexString";case 22:return"IA5String";case 23:return"UTCTime";case 24:return"GeneralizedTime";case 25:return"GraphicString";case 26:return"VisibleString";case 27:return"GeneralString";case 28:return"UniversalString";case 30:return"BMPString"}return"Universal_"+this.tag.tagNumber.toString();case 1:return"Application_"+this.tag.tagNumber.toString();case 2:return"["+this.tag.tagNumber.toString()+"]";case 3:return"Private_"+this.tag.tagNumber.toString()}},c.prototype.content=function(t){if(void 0===this.tag)return null;void 0===t&&(t=1/0);var e=this.posContent(),r=Math.abs(this.length);if(!this.tag.isUniversal())return null!==this.sub?"("+this.sub.length+" elem)":this.stream.parseOctetString(e,e+r,t);switch(this.tag.tagNumber){case 1:return 0===this.stream.get(e)?"false":"true";case 2:return this.stream.parseInteger(e,e+r);case 3:return this.sub?"("+this.sub.length+" elem)":this.stream.parseBitString(e,e+r,t);case 4:return this.sub?"("+this.sub.length+" elem)":this.stream.parseOctetString(e,e+r,t);case 6:return this.stream.parseOID(e,e+r,t);case 16:case 17:return null!==this.sub?"("+this.sub.length+" elem)":"(no elem)";case 12:return w(this.stream.parseStringUTF(e,e+r),t);case 18:case 19:case 20:case 21:case 22:case 26:return w(this.stream.parseStringISO(e,e+r),t);case 30:return w(this.stream.parseStringBMP(e,e+r),t);case 23:case 24:return this.stream.parseTime(e,e+r,23==this.tag.tagNumber)}return null},c.prototype.toString=function(){return this.typeName()+"@"+this.stream.pos+"[header:"+this.header+",length:"+this.length+",sub:"+(null===this.sub?"null":this.sub.length)+"]"},c.prototype.posStart=function(){return this.stream.pos},c.prototype.posContent=function(){return this.stream.pos+this.header},c.prototype.posEnd=function(){return this.stream.pos+this.header+Math.abs(this.length)},c.prototype.toHexString=function(t){return this.stream.hexDump(this.posStart(),this.posEnd(),!0)},c.prototype.getHex=function(){return this.stream.hexDump(this.posContent(),this.posEnd(),!0)},c.prototype.getAB=function(t){return void 0===t&&(t=!0),t?r(n(this.getHex())):n(this.getHex())},c}(),C=function(){function t(t){var e=t.get();if(this.tagClass=e>>6,this.tagConstructed=0!=(32&e),this.tagNumber=31&e,31==this.tagNumber){for(var r=new f;e=t.get(),r.mulAdd(128,127&e),128&e;);this.tagNumber=r.simplify()}}return t.prototype.isUniversal=function(){return 0===this.tagClass},t.prototype.isEOC=function(){return 0===this.tagClass&&0===this.tagNumber},t}(),B=function(t){var r=this;if("string"!=typeof t)throw new Error(c);this.type="public";var e=t.split("\n"),n=["-BEGIN PRIVATE KEY-","-END PRIVATE KEY-","-BEGIN EC PRIVATE KEY-","-END EC PRIVATE KEY-","-BEGIN RSA PRIVATE KEY-","-END RSA PRIVATE KEY-"],i=["-BEGIN RSA PUBLIC KEY-","-BEGIN EC PUBLIC KEY-","-BEGIN PUBLIC KEY-","-END PUBLIC KEY-","-END EC PUBLIC KEY-","-END RSA PUBLIC KEY-"],o=e.map(function(t){return t.trim()}).filter(function(t){return t.length&&function(e){return n.some(function(t){return-1<e.toUpperCase().indexOf(t)})?!(r.type="private"):!i.some(function(t){return-1<e.toUpperCase().indexOf(t)})}(t)}).join("");if(o.length)return this.body=p(a(h(o))),this;throw new Error(c)},N=[{name:"p-256",curve:"1.2.840.10045.3.1.7",coordinateLength:32},{name:"p-384",curve:"1.3.132.0.34",coordinateLength:48},{name:"p-384",curve:"1.3.132.0.35",coordinateLength:66}],i=function(){function i(){}return i.ASN1fromPEM=function(t){if(!t)throw new Error(c);t instanceof ArrayBuffer&&(t=new Uint8Array(t));var e=A.decode(t),r={};return 3===e.sub.length?(r.version=e.sub[0].content(),r.keyType=e.sub[1].sub[0].content(),r.namedCurve=e.sub[1].sub[1].content(),r.versionSub=e.sub[2].sub[0].sub[0].content(),r.privateKey=e.sub[2].sub[0].sub[2].getAB(),r.curveTypeSub=e.sub[2].sub[0].sub[2].sub[0].content(),r.publicKey=e.sub[2].sub[0].sub[3].sub[0].getAB()):2===e.sub.length&&(r.keyType=e.sub[0].sub[0].content(),r.namedCurve=e.sub[0].sub[1].content(),r.publicKey=e.sub[1].getAB()),e},i.JWKfromASN1=function(e,t,r){if(!e)throw new Error(c);if("private"===(t="string"==typeof t&&t.toLowerCase()||["public","private"][e.privateKey?1:0])&&!e.privateKey)throw new Error(c);var n=N.find(function(t){return t.curve===e.namedCurve});if(!n)throw new Error(c);var i=e.publicKey;if(4!==i.readInt8(0))throw new Error(c);var o=Object.assign({kty:"EC",crv:n.name},r,{x:v(g(i.slice(1,n.coordinateLength))),y:v(g(i.slice(n.coordinateLength+1,2*(n.coordinateLength+1))))});return"private"===t&&Object.assign(o,{d:v(g(e.privateKey))}),o},i.JWKfromEC=function(e,r,n){return s(function(){var t=new B(e);return i.JWKfromASN1(i.ASN1fromPEM(t.body),r,n)})},i}();function I(o,u,s,a){return new(s||(s=Promise))(function(t,e){function r(t){try{i(a.next(t))}catch(t){e(t)}}function n(t){try{i(a.throw(t))}catch(t){e(t)}}function i(e){e.done?t(e.value):new s(function(t){t(e.value)}).then(r,n)}i((a=a.apply(o,u||[])).next())})}function x(r,n){var i,o,u,t,s={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,o&&(u=2&e[0]?o.return:e[0]?o.throw||((u=o.return)&&u.call(o),0):o.next)&&!(u=u.call(o,e[1])).done)return u;switch(o=0,u&&(e=[2&e[0],u.value]),e[0]){case 0:case 1:u=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,o=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(u=0<(u=s.trys).length&&u[u.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!u||e[1]>u[0]&&e[1]<u[3])){s.label=e[1];break}if(6===e[0]&&s.label<u[1]){s.label=u[1],u=e;break}if(u&&s.label<u[2]){s.label=u[2],s.ops.push(e);break}u[2]&&s.ops.pop(),s.trys.pop();continue}e=n.call(r,s)}catch(t){e=[6,t],o=0}finally{i=u=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}var P="object"==typeof window&&(window.crypto||window.msCrypto),R=P&&(P.subtle||P.webkitSubtle||P.Subtle),T=function(){function a(){}return a.ASN1fromPEM=function(t){if(!t)throw new Error(c);t instanceof ArrayBuffer&&(t=new Uint8Array(t));var e=A.decode(t),r={};if(3===e.sub.length&&(e=e.sub[2].sub[0]),9===e.sub.length?(r.modulus=e.sub[1].getAB(),r.publicExponent=parseInt(e.sub[2].getHex(),16),r.privateExponent=e.sub[3].getAB(),r.prime1=e.sub[4].getAB(),r.prime2=e.sub[5].getAB(),r.exponent1=e.sub[6].getAB(),r.exponent2=e.sub[7].getAB(),r.coefficient=e.sub[8].getAB()):2===e.sub.length&&(e=e.sub[1].sub[0],r.modulus=e.sub[0].getAB(),r.publicExponent=parseInt(e.sub[1].getHex(),16)),r.bits=8*(r.modulus.length-1)+Math.ceil(Math.log(r.modulus[0]+1)/Math.log(2)),!r.bits)throw new Error(c);return r},a.JWKfromASN1=function(t,e,r){if(!t)throw new Error(c);if("private"===(e="string"==typeof e&&e.toLowerCase()||["public","private"][t.privateExponent?1:0])&&!t.privateExponent)throw new Error(c);var n=t.publicExponent,i=Math.ceil(Math.log(n)/Math.log(256)),o=new Uint8Array(i).map(function(t){return t=n%256,n=Math.floor(n/256),t}).reverse(),u=Object.assign({kty:"RSA"},r,{n:v(g(t.modulus)),e:v(g(o))});return"private"===e&&Object.assign(u,{d:v(g(t.privateExponent)),p:v(g(t.prime1)),q:v(g(t.prime2)),dp:v(g(t.exponent1)),dq:v(g(t.exponent2)),qi:v(g(t.coefficient))}),u},a.JWKfromRSA=function(e,r,n){return s(function(){var t=new B(e);return a.JWKfromASN1(a.ASN1fromPEM(t.body),r,n)})},a.createSigner=function(i){if(R)return{update:function(n){return{sign:function(e,t){return I(this,void 0,void 0,function(){var r=this;return x(this,function(t){return[2,a.JWKfromRSA(e,"private",{key_ops:["sign"],alg:i.replace("SHA-","RS")}).then(function(e){return I(r,void 0,void 0,function(){var r=this;return x(this,function(t){return[2,R.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:i}},!0,["sign"]).then(function(e){return I(r,void 0,void 0,function(){return x(this,function(t){return[2,R.sign({name:"RSASSA-PKCS1-v1_5",hash:{name:i}},e,p(n)).then(g).then(b)]})})})]})})})]})})}}}};if(o&&o.createSign)return o.createSign(i.replace("SHA-","RSA-SHA"));throw new Error(c)},a.sign=function(n){return function(e,r){return I(this,void 0,void 0,function(){return x(this,function(t){return[2,s(function(){return a.createSigner("SHA-"+n).then(function(t){return t.update(e).sign(r,"base64").then(l)})})]})})}},a.createVerifier=function(s){if(R)return{update:function(u){return{verify:function(e,o,t){return I(this,void 0,void 0,function(){var i=this;return x(this,function(t){return[2,a.JWKfromRSA(e,"public",{key_ops:["verify"],alg:s.replace("SHA-","RS")}).then(function(t){var e=t.kty,r=t.n,n=t.e;return I(i,void 0,void 0,function(){return x(this,function(t){return[2,R.importKey("jwk",{kty:e,n:r,e:n},{name:"RSASSA-PKCS1-v1_5",hash:{name:s}},!1,["verify"]).then(function(t){return R.verify("RSASSA-PKCS1-v1_5",t,p(d(o)),p(u))})]})})})]})})}}}};if(o&&o.createVerify)return o.createVerify(s.replace("SHA-","RSA-SHA"));throw new Error(c)},a.verify=function(o){return function(r,n,i){return I(this,void 0,void 0,function(){var e;return x(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,a.createVerifier("SHA-"+o).then(function(t){return t.update(r).verify(i,h(n),"base64")})];case 1:return[2,t.sent()];case 2:return e=t.sent(),[2,Promise.reject(new Error(e.message))];case 3:return[2]}})})}},a}(),K="object"==typeof window&&(window.crypto||window.msCrypto),U=K&&(K.subtle||K.webkitSubtle||K.Subtle),O=function(){function h(){}return h.createSigner=function(r,n){return I(this,void 0,void 0,function(){var e;return x(this,function(t){return U?(e=p(n),[2,U.importKey("raw",e,{name:"HMAC",hash:{name:r}},!0,["sign"]).then(function(r){return{update:function(e){return I(this,void 0,void 0,function(){return x(this,function(t){return[2,U.sign("HMAC",r,p(e))]})})}}})]):[2,o&&o.createHmac?Promise.resolve(o.createHmac(r.replace("SHA-","sha"),n)):Promise.reject(K)]})})},h.sign=function(f){return function(a,c){return I(this,void 0,void 0,function(){var e,r,n,i,o,u,s;return x(this,function(t){switch(t.label){case 0:return[4,h.createSigner("SHA-"+f,c)];case 1:return e=t.sent(),n=(r=Promise).resolve,U?(o=v,u=g,(s=e)?[4,e.update(a)]:[3,3]):[3,4];case 2:s=t.sent(),t.label=3;case 3:return i=o.apply(void 0,[u.apply(void 0,[s])]),[3,5];case 4:i=l(e&&e.update(a).digest("base64")),t.label=5;case 5:return[2,n.apply(r,[i])]}})})}},h.verify=function(i){return function(e,r,n){return I(this,void 0,void 0,function(){return x(this,function(t){switch(t.label){case 0:return[4,h.sign(i)(e,n)];case 1:return[2,t.sent()===r]}})})}},h}();t.ASN1=A,t.EC=i,t.PEM=B,t.RSA=T,t.HMAC=O,t.UNSUPPORTED_ALGORITHM='Unsupported algorithm name specified! Supported algorithms: "HS256", "HS384", "HS512", "RS256", "RS384", "RS512" and "none".',t.ILLEGAL_ARGUMENT=c,t.num2hex=e,t.cleanZeros=r,t.hex2AB=n,t.AB2hex=function(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),t.reduce(e,"")},t.tryPromise=s,t.s2AB=p,t.AB2s=g,t.b2s=a,t.b2bu=l,t.bu2b=h,t.bu2s=d,t.s2b=b,t.s2bu=v,Object.defineProperty(t,"__esModule",{value:!0})});
